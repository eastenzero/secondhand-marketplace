# 二手交易平台｜项目开发进度总览（MVP + 扩展模块）

> 目的：汇总当前项目在**后端、前端、数据库**三方面的功能完成度，并按模块列出已实现能力与后续待做/增强项，便于后续继续开发或写报告时引用。

---

## 1. 总体概况

- **技术栈与结构**
  - 后端：Spring Boot 3 + Java 17 + JPA + Flyway，目录在 `backend/`。
  - 数据库：PostgreSQL 15，核心 DDL 在 `database/db-schema.sql` 与 `backend/src/main/resources/db/migration/*.sql`。
  - 前端：React + TypeScript + Vite + Tailwind，目录在 `frontend/`。
- **主业务链路（均已打通到可演示程度）**
  - 注册/登录（JWT HttpOnly Cookie）。
  - 商品/需求的发布、搜索/筛选、详情查看。
  - 报价、留言。
  - 我的发布（商品/需求）管理：编辑、上下架、删除。
  - 基础审核台（pending→active）。
- **已扩展的模块（超出最初 MVP 范围，后端已实现、前端部分覆盖）**
  - 订单与交易记录：从报价生成订单、订单详情。
  - 评分与评价：对用户/商品/需求/订单的评分与评价。
  - 聊天与站内信：会话 threads + messages。
  - 通知中心：notifications 表 + 后端查询/已读接口。
  - 内容安全与风控：举报 reports、用户封禁 user_bans，加上审计日志 audit_logs。

以下各节按**模块视角**总结“已实现功能”和“[TODO] 待完成/增强”的清单。

---

## 2. 后端模块状态（Spring Boot）

参考：`backend/backend-components-status.md` + 控制器/服务代码。

### 2.1 用户与认证（User & Auth）

**已实现**
- 表与实体
  - `users` 表 + `User` 实体：`username` 唯一、`password_hash`、`status`（active/disabled）、`role`（MEMBER/ADMIN）、`created_at`。
- 接口
  - `POST /api/register`：注册，用户名查重，BCrypt 加密，错误码 `USERNAME_TAKEN`、`VALIDATION_ERROR`，写审计日志 `REGISTER/REGISTER_FAILED`。
  - `POST /api/login`：登录成功生成 JWT，由 `AuthController` 通过 HttpOnly Cookie `sid` 返回，登录失败返回 `AUTH_FAILED` 并写 `LOGIN_FAILED`。
  - `POST /api/logout`：清除 sid Cookie。
- 安全与鉴权
  - `SecurityConfig`：匿名访问 `/api/register`, `/api/login`, GET `/api/items/**`, GET `/api/demands/**`, GET `/api/comments/**`, `/actuator/health`，其余默认需要登录。
  - JWT 过滤器 + `AuthenticatedUser` 封装当前用户；方法级 `@PreAuthorize`，如 ADMIN 访问举报/封禁接口。

**[TODO] / 增强建议**
- [TODO] 登录时根据 `users.status`（active/disabled）限制被禁用用户登录，并返回对应错误码/提示。
- [TODO] 用户资料/安全相关业务接口（修改联系方式、修改密码、重置密码等），目前前端 Settings 只做了本地状态更新，没有对应后端 API。

---

### 2.2 商品 Items 模块

**已实现**
- 表与实体
  - `items` 表 + `Item` 实体，字段包含 `seller_id`、`title`、`price`、`status`（draft/pending/active/off/deleted）、`images`、`created_at/updated_at/deleted_at` 等。
  - 索引：按 `status`、`category`、`created_at` 及 active+category 的部分索引。
- 核心接口（`ItemController` + `ItemService`）
  - `GET /api/items`：分页搜索，支持 keywords、category、minPrice、maxPrice，错误码 `INVALID_RANGE` 等。
  - `GET /api/items/{id}`：详情，deleted 记录视为 `NOT_FOUND`。
  - `POST /api/items`：发布商品；根据配置 `app.review.enabled` 决定初始状态 `pending` 或 `active`；写审计 `ITEM_CREATE`。
  - `PATCH /api/items/{id}`：信息管理，`action="update|off"`，仅 `sellerId == 当前用户` 可操作，否则 `FORBIDDEN_OWNER`；写审计 `ITEM_UPDATE/ITEM_OFF`。
- 状态与权限
  - 统一使用 `ItemStatus` 枚举和 `ListingPermissionService.assertItemOwner` 做所有权校验。

**[TODO] / 增强建议**
- [TODO] 详情接口目前仅返回 `offers: []`、`comments: []` 占位，未真正聚合最近的报价与留言。
- [TODO] 增加显式 `delete` 动作，执行软删（`status=deleted` + `deleted_at`）。
- [TODO] 进一步明确 `off` 状态资源是否对非 owner 隐藏详情（目前 off 仍可直链访问）。

---

### 2.3 需求 Demands 模块

**已实现**
- 表与实体
  - `demands` 表 + `Demand` 实体，字段包括 `buyer_id`、`title`、`expected_price`/预算区间、`status` 与时间字段等。
- 接口（`DemandController` + `DemandService`）
  - `GET /api/demands`：分页搜索 active 需求。
  - `GET /api/demands/{id}`：详情，deleted 视为 `NOT_FOUND`。
  - `POST /api/demands`：发布需求。
  - `PATCH /api/demands/{id}`：`action="update|off"`，按 `buyerId` 做所有权校验，审计 `DEMAND_CREATE/DEMAND_UPDATE/DEMAND_OFF`。

**[TODO] / 增强建议**
- [TODO] 与 Items 一致，在详情接口中聚合最近 N 条报价与留言。
- [TODO] 增加逻辑删除 delete 动作。

---

### 2.4 报价 Offers 模块

**已实现**
- 表与实体
  - `offers` 表 + `Offer` 实体：`target_type(item|demand)`、`target_id`、`offerer_id`、`amount`、`status(created/accepted/rejected/canceled)`、`created_at` 等。
- 接口（`OfferController` + `OfferService`）
  - `POST /api/offers`：创建报价。
  - 校验：金额>0（`INVALID_AMOUNT`）、目标存在（`TARGET_NOT_FOUND`）、目标 active（`TARGET_NOT_ACTIVE`）、禁止对自己资源报价（`SELF_OFFER_NOT_ALLOWED`）。
  - 审计：`OFFER_CREATE`。

**[TODO] / 增强建议**
- [TODO] 报价生命周期后续操作（接受/拒绝/取消）目前未作为独立接口暴露（`PATCH /api/offers/{id}` with action=accept/reject/cancel 仅在文档中规划）。
- [TODO] 更完善的状态机与并发控制（接受一个报价后，如何联动商品/需求状态，避免并发修改）。

---

### 2.5 订单 Orders 模块（扩展）

> 该模块是基于 db-design-prompt 中“报价与交易”扩展出来的，已实现从报价生成正式订单与订单详情查询。

**已实现**
- 表与实体
  - `orders` + `Order`：`buyer_id`、`seller_id`、`offer_id`、`total_amount`、`status(created/paid/canceled/completed)`、收货人/地址/支付方式等。
  - `order_items` + `OrderItem`：多态 `target_type(item|demand)` + `target_id`、数量与价格。
- 接口（`OrderController` + `OrderService`）
  - `POST /api/orders`：`createOrderFromOffer`，从已存在的报价生成订单：
    - 校验报价存在且 `status=created`，目标商品/需求 active。
    - 根据报价目标类型（item/demand）推导买家/卖家身份。
    - 当前用户必须是买家或卖家，否则 `FORBIDDEN_OWNER`。
    - 创建 `Order` + `OrderItem`，并将报价状态置为 `accepted`。
  - `GET /api/orders/{id}`：返回订单详情及订单条目列表。
- 审计
  - 创建订单时写 `ORDER_CREATE` 审计日志。

**[TODO] / 增强建议**
- [TODO] 支付/状态流转接口（如 `pay/cancel/complete`），目前仅有 `created` 状态与只读详情。
- [TODO] 订单列表（按买家/卖家分页）接口与前端页面尚未实现。

---

### 2.6 留言 Comments 模块

**已实现**
- 表与实体
  - `comments` 表 + `Comment` 实体：`target_type(item|demand)`、`target_id`、`user_id`、`content`、`created_at` 等。
- 接口（`CommentController` + `CommentService`）
  - `POST /api/comments`：新增留言，校验目标存在、内容非空/长度合法，错误码 `TARGET_NOT_FOUND`、`CONTENT_INVALID`。
  - `GET /api/comments`：按 `targetType + targetId` 分页倒序返回 `{ total, comments[] }`。
  - 审计：`COMMENT_CREATE`。

**[TODO] / 增强建议**
- [TODO] 在 Item/Demand 详情接口中聚合最近 N 条评论（当前返回空数组占位，由前端独立调用评论列表）。
- [TODO] 留言编辑/删除接口（可能需要角色与审核策略）。

---

### 2.7 评分与评价 Reviews 模块（扩展）

**已实现**
- 表与实体
  - `reviews` 表 + `Review` 实体：
    - 目标类型 `user/item/demand/order`，评分 1–5，公开/内部备注，`status(active/hidden/deleted)` 等。
- 服务与接口（`ReviewService` + `ReviewController`）
  - `POST /api/reviews`：创建评价。
    - 校验 targetType/targetId 有效。
    - 若是对 `order` 评价，校验当前用户必须是该订单的买家或卖家，否则 `FORBIDDEN_OWNER`。
    - rating 必须在 [1, 5]，否则 `VALIDATION_ERROR`。
    - 支持公开/内部备注字段，并写 `REVIEW_CREATE` 审计。
  - `GET /api/reviews`：根据 `targetType + targetId` 分页返回公开且 status=active 的评价列表。

**[TODO] / 增强建议**
- [TODO] 前端尚未对接评分接口与展示评分 UI（目前无对应页面/组件）。
- [TODO] 是否允许用户编辑/删除自己的评价、对差评进行申诉等策略未实现。

---

### 2.8 聊天与站内信（Threads & Messages）

**已实现**
- 表与实体
  - `threads`：会话（针对 item/demand/order/system），维护创建人、状态（active/muted/closed）、时间戳。
  - `messages`：消息，字段包括 `thread_id`、`sender_user_id`、`recipient_user_id`、`content`、`is_read`、`status(active/recalled/deleted)` 等，并有未读索引。
- 接口与服务（`ChatController` + `ChatService`）
  - `POST /api/threads`：创建会话并发送首条消息：
    - 需登录（否则 `AUTH_REQUIRED`）。
    - 校验 `targetType` 合法、`recipientUserId` 存在且不能是自己。
    - 创建 `ChatThread`，随后插入首条 `Message`，状态 active，写审计 `THREAD_CREATE`。
  - `GET /api/threads/{id}/messages`：分页查询指定会话下消息列表。

**[TODO] / 增强建议**
- [TODO] 列表我的会话（threads 列表）接口尚未暴露，仅有按 threadId 拉取消息。
- [TODO] 消息已读状态更新、撤回、删除等操作接口未实现。
- [TODO] 前端 Chat 页面当前为纯 Mock 数据，未对接上述后端 API。

---

### 2.9 通知 Notifications 模块

**已实现**
- 表与实体
  - `notifications` 表 + `Notification` 实体：`user_id`、`type`、`title`、`content`、`related_type/related_id`、`is_read`、`status(active/archived/deleted)`、时间戳等。
- 接口与服务（`NotificationController` + `NotificationService`）
  - `GET /api/notifications/me`：当前登录用户的通知列表，分页；仅返回 `status=active` 的通知。
  - `PATCH /api/notifications/{id}/read`：将单条通知标记为已读，带所有权校验；更新 `read_at`。

**[TODO] / 增强建议**
- [TODO] 目前前端 `NotificationsPage` 仍使用本地 `MOCK_NOTIFICATIONS`，尚未改为调用上述 API。
- [TODO] 通知触发点有限，后端只建了基础表与查询/已读接口，尚未系统性在“报价、留言、审核结果”等事件中自动写通知。

---

### 2.10 内容安全与风控（举报 / 封禁 / 审计）

**已实现**
- 举报 Reports
  - 表 `reports` + `Report` 实体：支持对 `user/item/demand/offer/comment/order/message/review` 的举报，状态 `pending/reviewing/resolved/rejected`，resolution 字段等。
  - 接口（`ReportController` + `ReportService`）：
    - `POST /api/reports`：任意登录用户可发起举报，校验目标存在，写审计 `REPORT_CREATE`。
    - `GET /api/reports/admin`：管理员分页查看指定状态（默认 pending）的举报。
    - `POST /api/reports/admin/{id}/manage`：管理员处理举报，支持 action=`reviewing|resolve|reject`，写 `REPORT_MANAGE` 审计。
- 用户封禁 User Bans
  - 表 `user_bans` + `UserBan` 实体：封禁目标用户、原因、状态（active/revoked/expired）、起止时间、管理员 ID 等。
  - 接口（`UserBanController` + `UserBanService`）：
    - `POST /api/admin/user-bans`：管理员创建封禁，校验用户存在且当前无 active 封禁；写审计 `USER_BAN_CREATE`。
    - `GET /api/admin/user-bans`：分页查看封禁记录。
    - `PATCH /api/admin/user-bans/{id}/revoke`：撤销封禁，写审计 `USER_BAN_REVOKE`。
- 审计日志 Audit Logs
  - 表 `audit_logs` + `AuditLog` 实体 + `AuditService`：
    - 在注册、登录、商品/需求创建与管理、报价、留言、订单、举报、封禁、评价等关键操作写入审计记录。

**[TODO] / 增强建议**
- [TODO] 统一在认证/请求入口处根据 `user_bans` 自动拦截被封禁用户的访问并返回适当错误码（目前仅有管理与记录）。
- [TODO] 前端尚未实现举报入口、举报管理后台、封禁管理 UI。
- [TODO] 更多风控策略（频率限制、敏感词过滤等）可以在现有架构上扩展。

---

### 2.11 错误处理、状态机与可观测性

**已实现**
- 错误码与异常
  - 统一返回格式：`{ code, message }`。
  - `BusinessException + ErrorCode` + `GlobalExceptionHandler`，将业务错误映射到 HTTP 状态：401/403/404/409/400/422/429 等。
- 状态机与软删
  - `ItemStatus` 统一用于 Items 与 Demands；deleted 状态在详情中视为 `NOT_FOUND`，搜索仅查 active。
- 审计与 Trace
  - `AuditService` + `AuditLog`，记录关键操作。
  - `TraceIdFilter` 为每个请求生成/透传 `X-Trace-Id` 并放入 MDC。
- 基础 NFR
  - 简单 IP 级限流 `IpRateLimiter` 用于注册/登录等高风险接口。
  - Actuator `/actuator/health` 健康检查开放。
- 测试
  - `BaseIntegrationTest` 提供 MockMvc 脚手架与通用辅助方法，覆盖代表性用例（注册、登录失败、自报价拦截、留言写入等）。

**[TODO] / 增强建议**
- [TODO] 更细粒度的异常类型（`AuthException` 等）与监控聚合。
- [TODO] 引入 micrometer + Prometheus 指标、结构化 JSON 日志输出。
- [TODO] 扩展集成测试覆盖边界情况（分页极值、非法价格区间、off/deleted 状态回归等）。

---

## 3. 前端功能状态（React + TS + Vite）

参考：`frontend/frontend-gap-analysis.md`、`frontend/plan-backlog-frontend.md`、`frontend/src/router.tsx` 及各页面源码。

### 3.1 已完成的核心业务流

**已实现**
- 认证
  - `/login`、`/register` 页面，表单校验与错误提示，对接后端 `/api/login` / `/api/register`。
  - 全局 Axios 拦截器（`src/services/api.ts`）根据错误码/状态统一弹出提示，并在 401 时清理登录态并跳转登录页。
- 商品与需求
  - 列表页 `/items`、`/demands`：支持关键词、分类、价格区间筛选与分页，加载 Skeleton 与空态展示。
  - 详情页 `/items/:id`、`/demands/:id`：展示基础信息、卖家/求购者信息、预算/价格区间等。
  - 发布与编辑 `/publish/item`、`/publish/demand`：表单校验、图片上传组件（Item）、参考图片（Demand），提交成功后跳转详情。
- 报价与留言
  - 详情页集成 `OfferDialog` 发起报价（item/demand），提交后回调刷新详情。
  - `CommentList` 组件支持针对商品/需求的留言展示与分页加载（对接 `/api/comments`）。
- 我的发布与审核
  - `/me/posts`：我的商品/需求列表，支持跳转详情、编辑、上下架/关闭、删除（调用 items/demands 服务）。
  - `/admin/review`：管理员审核台，按 pending 状态列出待审核的商品/需求，支持“通过/拒绝”操作（调用更新接口，前端直接变更 status）。
- 个人设置
  - `/me/settings`：本地模拟的个人资料编辑（昵称、签名、头像上传组件），更新仅写入前端 `useAuthStore`，未实际调用后端。

---

### 3.2 仍为占位或未对接的功能

**通知中心与消息**
- 当前 `NotificationsPage`：
  - 使用 `MOCK_NOTIFICATIONS` 常量，本地维护已读/全部已读状态。
  - **未调用** 后端 `GET /api/notifications/me`、`PATCH /api/notifications/{id}/read`。
- 当前 `ChatPage`：
  - 使用 `MOCK_CONVERSATIONS` 对话与消息，本地发送消息仅更新内存。
  - **未调用** 后端聊天接口（`POST /api/threads`、`GET /api/threads/{id}/messages`），也未实现会话列表 API 对接。

**交易闭环与评价**
- 商品详情页“立即购买”按钮仅调用 `toast.info('支付功能即将上线')`，
  - **未对接** `/api/orders` 创建订单。 
- 前端尚无“订单列表/订单详情”页面，也未对接 `GET /api/orders/{id}`。
- 评分/评价：前端暂无页面与组件，对应后端 `/api/reviews` 全部未使用。

**账户与资料管理**
- Settings 页：
  - 头像上传通过 `ImageUpload` 组件选择图片，但仅更新本地表单数据。
  - 保存时只更新 `useAuthStore` 中的 `user.name`，
  - **未对接** 任何用户资料/安全相关后端接口。

**管理后台扩展**
- 报表/统计：暂无用户量、交易量、GMV 等统计页面。
- 举报处理与封禁管理：
  - 后端已经有 `/api/reports`、`/api/admin/user-bans` 等接口；
  - 前端暂无举报入口（从商品/需求/留言等处发起举报）与对应的管理后台页面。
- 用户管理：未实现管理员查看用户列表、禁用/解封用户的 UI。

**技术债（与 `frontend/frontend-gap-analysis.md` 一致）**
- Mock 数据：
  - 部分页面（通知、聊天）仍完全基于 Mock；其余业务已逐步对接后端。
- 类型与测试：
  - TS 类型整体合理，但尚无系统性的单元测试/集成测试/E2E 测试实装。
- 性能与 A11y：
  - 已有 Lazy 路由、Skeleton、基础响应式，但尚未针对性能与无障碍做专项优化与验证。

---

### 3.3 与后端契约可能不完全一致的点（需联调确认）

- 我的发布 `/me/posts`：
  - 前端在切换状态时使用了 `status='inactive'`，而后端 Items/Demands 的枚举状态为 `draft/pending/active/off/deleted`，没有 `inactive`，需要改为对应 `off` 或增加映射规则。
- 审核台 `/admin/review`：
  - 前端审核拒绝时将 status 改为 `rejected`，但当前后端 Items/Demands 的 status 约束中也未包含 `rejected`。
  - 实际应该通过管理接口 action（如 `off` 或单独的审核接口）来实现，需统一状态机与接口设计。

---

## 4. 数据库 Schema 与迁移状态

**核心表（节选）** – 见 `database/db-schema.sql`
- 用户与账户：`users`
- 商品与需求：`items`、`demands`
- 报价与交易：`offers`、`orders`、`order_items`
- 留言与评价：`comments`、`reviews`
- 聊天与通知：`threads`、`messages`、`notifications`
- 内容安全与风控：`audit_logs`、`reports`、`user_bans`

**迁移脚本** – 见 `backend/src/main/resources/db/migration/`
- `V1__init_schema.sql`：users/items/demands/offers/comments/audit_logs 初始表。
- `V2`–`V4`：用户角色、desc 字段兼容重命名、demands 类索引等。
- `V5__add_orders_tables.sql`：订单与订单条目。
- `V6__add_reviews_table.sql`：评价表。
- `V7__add_threads_messages_notifications.sql`：会话、消息与通知。
- `V8__add_reports_and_user_bans.sql`：举报与封禁。

**评估**
- 数据库层面已经基本覆盖了 db-design-prompt 中规划的各个模块（用户与账户、商品与求购、报价与交易、评论与评分、聊天与通知、内容安全与风控）。
- 后续若增加新功能（例如更细粒度的图片管理、地区/学校维度、搜索索引优化等），可以通过新增表/字段和新增迁移脚本平滑演进。

---

## 5. Backlog 对照与未完成事项汇总

### 5.1 后端 Backlog（B1–B10）简要对照

- **B1 数据库初始化**：已完成（Flyway + core DDL）。
- **B2 认证模块**：已完成（注册/登录/登出、JWT、基础权限）。
- **B3–B4 商品发布/详情/搜索**：已完成，缺少详情聚合 offers/comments 与 delete 动作。
- **B5 需求模块**：已完成，对称于 Items。
- **B6 报价 API**：发起报价已完成；报价后续生命周期与更严格状态机为 [TODO]。
- **B7 留言 API**：已完成；详情聚合评论为 [TODO]。
- **B8 信息管理（更新/下架/软删）**：update/off 已落地；显式 delete 动作与 off 状态可见性为 [TODO]。
- **B9 审计与错误码统一**：已完成并应用在关键路径。
- **B10 非功能基线**：限流、健康检查、部分日志已具备；Prometheus 指标、结构化日志与完善测试仍为 [TODO]。

### 5.2 前端 Backlog（F0–F11）简要对照

- **F0 项目骨架/路由/样式/质量工具**：已完成。
- **F1 认证（登录/注册）**：已完成，对接后端并处理 401/403。
- **F2–F3 商品列表/详情/发布**：已完成。
- **F4 搜索/筛选/分页**：商品/需求两个方向均已实现。
- **F5 需求列表/详情/发布**：已完成，对称实现。
- **F6 发起报价**：已完成（OfferDialog）。
- **F7 留言（新增/列表）**：已完成（CommentList + 评论服务）。
- **F8 我的管理（更新/下架/删除）**：页面已实现，但与后端状态枚举存在契约不一致，需要修正为 `off` 或其他合法值。
- **F9 审核台（可选）**：页面已实现且调用更新接口，但后端尚无 `rejected` 状态等审核专用流转，需要后端与前端一起对齐状态机与接口。
- **F10 错误码与日志统一**：Axios 拦截器 + 错误码文案映射已落地，基本完成。
- **F11 性能与 A11y 硬化**：懒加载与 Skeleton 已有，尚缺系统性的性能测试与 A11y 检查，可视为部分完成。

### 5.3 重点未完成 / 后续优先级建议

结合上文各节，可归纳若干关键 [TODO]：

- **业务闭环与对齐**
  - [TODO] 报价生命周期 + 订单支付/状态流转 + 订单列表/详情 UI。
  - [TODO] 评价模块的前端对接与展示（对用户/交易的评分与评价）。
  - [TODO] 我的发布、审核台与后端状态机/枚举的契约统一（active/off/rejected 等）。
- **聊天与通知**
  - [TODO] 前端对接后端聊天与通知 API，替换当前 Mock；补充“我的会话列表”“未读消息计数”等能力。
  - [TODO] 后端完善通知生成逻辑，将报价/留言/审核结果等关键事件写入 notifications。
- **内容安全与运营后台**
  - [TODO] 商品/需求/留言/用户的举报入口与举报管理后台 UI。
  - [TODO] 基于 user_bans 的运营封禁管理界面与登录拦截逻辑。
- **NFR 与测试**
  - [TODO] 监控指标（Prometheus）、结构化日志与 TraceId 统一输出配置。
  - [TODO] 更全面的后端集成测试 + 前端单元/E2E 测试，覆盖核心路径与边界情况。

---

> 使用方式：
> - 如果是写课程设计报告，可以直接引用本文件的结构与各模块状态说明。
> - 如果是继续迭代开发，可以以“5.3 重点未完成 / 后续优先级建议”作为下一轮任务清单的基础。
