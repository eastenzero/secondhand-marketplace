 # 开发启动包（二手交易平台）

> 目的：面向开发启动，统一需求/DFD/OOA，沉淀可执行的落地计划与工件。当前优先提供“资料清点与结构映射”“一致性与缺口核对”两节初稿，后续将补完架构、API、数据库、测试与实施计划。

## 1 资料清点与结构映射

### 1.1 关键文件与来源

| 文件/图表 | 路径 | 类型 | 来源/版本 | 作用/说明 |
| --- | --- | --- | --- | --- |
| 终稿（不改动） | /home/software/课程设计报告.docx | 文档 | 终稿 | 最终排版与内容依据（后续用于对齐与导出） |
| 草稿（便于引用） | /home/software/课程设计报告草稿.md | 文档 | 草稿 | 便于引用/扩展，含引言/需求/设计/测试摘要 |
| 结构化需求分析 | /home/software/二手交易平台_结构化需求分析_export.md | 文档 | 实验一 | 含第0/1/2层 DFD 与数据字典节选 |
| OOA 文档 | ../实验四 面向对象的软件分析.md/实验四 面向对象的软件分析.md | 文档 | 实验四 | 含对象模型、用例图、顺序图/状态图说明 |
| DFD 图（主用） | ../images/dfd-0.png, ../images/dfd-1.png, ../images/dfd-2a.png, ../images/dfd-2b.png, ../images/dfd-2c.png | 图片 | 实验一 | DFD 第0/1/2层配图（相对路径） |
| DFD 图（备份） | ../LINUX/images/dfd-*.png | 图片 | 备份 | 与主用一致，作为冗余备份 |
| OOA 图（PNG） | ../实验四 面向对象的软件分析.md/assets/ooa-*.png | 图片 | 实验四 | 用例/对象/时序/状态图 PNG |
| OOA 源（Mermaid） | ../实验四 面向对象的软件分析.md/assets/ooa-*.mmd | 源文件 | 实验四 | 可编辑的 Mermaid 源文件 |
| 模板结构提取 | /home/software/模板结构提取.md | 文档 | 提取稿 | 与模板 docx 对齐的结构骨架与样式要点 |

说明：图像与资源均以相对路径引用，最终导出 Docx/PDF 时按模板统一编号与图题。

### 1.2 图表清单与编号

- **[图DFD-0]** 第0层数据流图（上下文）：../images/dfd-0.png
- **[图DFD-1]** 第1层数据流图（主要子过程与数据存储）：../images/dfd-1.png
- **[图DFD-2A]** 第2层-搜索与报价细化：../images/dfd-2a.png  
- **[图DFD-2B]** 第2层-商品与需求细化：../images/dfd-2b.png  
- **[图DFD-2C]** 第2层-系统维护细化：../images/dfd-2c.png
- **[图UC]** 用例图：../实验四 面向对象的软件分析.md/assets/ooa-usecase.png
- **[图CL]** 对象模型（类图）：../实验四 面向对象的软件分析.md/assets/ooa-domain-class.png
- **[图SEQ-OFF]** 顺序图-发起报价：../实验四 面向对象的软件分析.md/assets/ooa-seq-offer.png
- **[图SEQ-PUB]** 顺序图-发布信息：../实验四 面向对象的软件分析.md/assets/ooa-seq-publish.png
- **[图STATE]** 状态图-商品/需求：../实验四 面向对象的软件分析.md/assets/ooa-state-item.png

### 1.3 术语与实体对齐（摘录）

- **实体**：用户(User)、商品(Item)、需求(Demand)、报价(Offer)、留言(Comment)、审计日志(AuditLog)
- **关键状态**：商品/需求∈{draft, pending, active, off, deleted}（来自 OOA 状态图与草稿表结构）
- **核心数据存储**：用户库、商品库、需求库、报价库、留言库、日志/备份库（见结构化需求分析数据字典）

### 1.4 需求↔用例↔DFD/存储↔类/状态/顺序图 映射表

| 需求项 | 用例名 | DFD 流程 | 主要数据存储 | 主要类 | 状态图 | 顺序图/活动 | 备注 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 注册 | 注册会员 | 注册管理 | 用户库 | User | - | - | DFD 已覆盖注册；登录在下一行说明 |
| 登录 | 登录 | （未在 DFD 明示） | 用户库 | User/Auth | - | - | 未决：DFD 未体现登录，会在一致性修复中补充 |
| 发布信息（商品） | 发布信息 | 商品与需求管理 | 商品库、日志/审核记录 | Item, AuditLog | 商品/需求状态图 | 图SEQ-PUB | 支持待审/直接上架（受配置） |
| 发布信息（需求） | 发布信息 | 商品与需求管理 | 需求库、日志/审核记录 | Demand, AuditLog | 商品/需求状态图 | 图SEQ-PUB | 同上 |
| 搜索与查看详情 | 搜索与查看详情 | 搜索与报价处理；详情读取 | 商品库、需求库、报价库、留言库 | Item, Demand, Offer, Comment | - | （待补） | 需补充检索/详情顺序图 |
| 发起报价 | 发起报价 | 搜索与报价处理 | 报价库（写）、商品/需求库（读校验） | Offer | - | 图SEQ-OFF | 约束：金额>0、禁止自报价 |
| 留言互动 | 留言互动 | 留言管理 | 留言库 | Comment | - | （待补） | 建议新增留言顺序图 |
| 信息管理 | 信息管理 | 各管理子过程 | 商品/需求/报价/留言库 | Item, Demand, Offer, Comment | 商品/需求状态图 | （待补） | 含修改、下架、删除、撤回等 |
| 审核/下架（可选） | 审核/下架 | 商品与需求管理 | 审核记录、日志 | Item, AuditLog | 商品/需求状态图 | （待补） | 受运营策略与配置开关控制 |

注：图号参见 1.2。DFD 流程与数据存储名称来自“二手交易平台_结构化需求分析_export.md”。

---

## 2 一致性与缺口核对（初稿）

### 2.1 名称/字段一致性

- **一致**：实体命名（User/Item/Demand/Offer/Comment/AuditLog）在 DFD 数据字典、OOA、草稿文档中保持一致。
- **轻微差异**：
  - 字段 `desc`（数据字典/草稿）vs `description`（行业习惯）。默认保留 `desc`，文档统一释义为“描述”。
  - 注册联系方式：数据字典为 `phone/email`，接口草案为 `contact`。默认统一为 `contact`（结构为对象：{phone?, email?}）。
  - `images` 字段的数据结构未定。默认使用字符串数组存放对象存储 URL，后续可抽象为独立资源表。

### 2.2 状态机与用例流一致性

- **商品/需求状态**：OOA 状态图提供 {draft→pending→active→off/deleted}，与发布/审核/上下架用例一致；草稿表结构状态枚举 `draft/pending/active/off/deleted` 对齐。
- **报价约束**：用例与草稿一致（金额>0、禁止自报价、目标有效）。报价状态值未细化（见缺口）。

### 2.3 DFD 与数据字典一致性

- **一致**：注册/搜索/发布/报价/留言/信息管理的数据流与相应数据存储在数据字典中均有映射。
- **缺口**：
  - 登录认证流程未在 DFD 中明示（仅在文本中作为前置/会话处理）。
  - 系统维护（图DFD-2C）未在需求文本中明确到接口与验收项，多为运维层面说明（日志/备份）。

### 2.4 差异与缺口清单（按影响度×修复难度排序）

| 编号 | 问题/差异 | 影响度 | 修复难度 | 建议修复与默认值 | 依据 |
| --- | --- | --- | --- | --- | --- |
| G1 | 登录认证流程未在 DFD 展示 | 高 | 低 | 在第1层 DFD 增加“认证/会话管理”子过程，或在上下文图备注；默认使用基于 JWT 的会话（HttpOnly Cookie） | 行业实践；草稿含登录接口 |
| G2 | 搜索/详情、留言的顺序图缺失 | 中 | 中 | 新增两张顺序图（搜索→详情；留言增删查），Mermaid 源放 assets/derived/ | OOA 现有仅报价/发布 |
| G3 | 审核开关未定义（策略/角色） | 中 | 低 | 增加系统配置 `review.enabled`，默认关闭；开启时角色 admin 具审核权限 | 草稿与OOA均提“可选” |
| G4 | 字段命名不统一（desc vs description；phone/email vs contact） | 中 | 低 | 文档与 API/DDL 统一为 `desc`、`contact`；对外接口保留语义清晰的别名映射 | 数据字典/草稿 |
| G5 | 报价 `status` 取值未定义 | 中 | 低 | 增加枚举：created, accepted, rejected, canceled；默认 created | 行业实践 |
| G6 | 图片 `images` 结构未定 | 中 | 中 | 初期使用 URL 数组；后续可抽表 `item_images`（item_id, url, sort） | 可维护性 |
| G7 | 删除 vs 下架的边界不清 | 高 | 低 | 统一：`off` 为可恢复下架；`deleted` 软删（保留审计），禁止硬删 | OOA 状态+运营合规 |
| G8 | 数据字典未覆盖分页/排序策略 | 低 | 低 | 统一分页参数 page/size、排序 sort；留言/报价按时间倒序 | 草稿/行业实践 |
| G9 | 分类/地域字典未定义 | 低 | 低 | 初期自由文本，后续引入字典表 `categories`、`cities` | 体验/扩展性 |
| G10 | 备份/恢复 RPO/RTO 未量化 | 低 | 低 | 后续在 NFR 中量化：RPO≤24h，RTO≤4h（默认） | NFR 章节 |

### 2.5 未决问题与默认值（为不阻塞推进）

- **认证方式**：默认 JWT + HttpOnly Cookie，Token 有效期 7 天，滑动续期。可切换为 Session + Redis。
- **审核策略**：默认关闭；开启后“发布信息”进入 `pending`，管理员审核通过后 `active`。
- **图片存储**：默认使用对象存储 URL（占位字段 `images: string[]`）。
- **报价状态**：默认 `created` 起始；接受/拒绝/撤销流程在后续API中定义。
- **删除策略**：默认软删（`deleted` 状态 + `deleted_at`），保留审计。

---

## 3 系统架构与非功能（MVP）
 
### 3.1 逻辑分层与模块
 - 表现层 → 接口层（REST） → 领域服务层（用户/商品/需求/报价/留言） → 数据访问层（Repository/DAO）。
 - 外部依赖抽象：对象存储（图片）、通知/消息、缓存/搜索（可选）。
 
### 3.2 架构图
 - 图ARCH-1 应用逻辑架构（Mermaid 源：assets/derived/arch-logic.mmd；PNG：assets/derived/arch-logic.png）
 
### 3.3 部署建议（单体优先，小步演进）
 - 单体应用 + PostgreSQL，Nginx 作反向代理与静态资源；环境变量管理配置。
 - 12-Factor 实践；日志标准化（JSON），错误码统一；健康检查与探针。
 
### 3.4 非功能性需求（量化指标）
 
 | 维度 | 指标 | 验证方法 | 备注 |
 | --- | --- | --- | --- |
 | 性能 | 页面/主要接口 P95 ≤ 2s；搜索列表 P95 ≤ 800ms | JMeter/Locust 压测，50并发、10分钟稳态 | 建索引，结果分页缓存 |
 | 可靠 | 备份/恢复：RPO ≤ 24h，RTO ≤ 4h | 备份脚本 + 每周演练 | 软删 + 审计日志 |
 | 安全 | JWT HttpOnly Cookie；BCrypt≥10；鉴权/越权用例通过 | 渗透/静态检查 + 单测 | 统一错误处理与审计 |
 | 可维护 | 代码覆盖率 ≥ 60%；基础监控告警 | CI 持续集成 + 可观测性 | 日志追踪ID |
 
 ---
 
 ## 4 领域模型与数据库
 
 - 图ER-1 概念模型（Mermaid 源：assets/derived/er.mmd；PNG：assets/derived/er.png）
 - 可执行 DDL：../database/db-schema.sql（PostgreSQL 15）。选择理由：原生约束/数组/JSON 能力强、事务与并发佳；MySQL 为备选。
 - 主键：雪花/BIGSERIAL；软删：`deleted` 状态 + `deleted_at`；
 - 关联：`offers/comments` 通过 `(target_type,target_id)` 关联到 `items/demands`（应用层校验），减少跨表外键耦合；
 - 索引：按卖家/买家、状态、创建时间与热门查询列建立；`items(category) WHERE status='active'` 局部索引支撑在线检索。
 
 ---
 
 ## 5 API 设计（MVP）
 
 - 详见 api-spec.md（含鉴权、Schema、示例、错误码与用例/DFD对应）。
 - 覆盖：注册/登录、发布（商品/需求）、搜索与详情、报价、留言、信息管理（更新/下架）。
 - 认证：JWT HttpOnly Cookie；未登录 401；资源所有权 403。
 
 ---
 
 ## 6 测试计划与质量
 
 ### 6.1 功能用例（节选）
 
 | ID | 用例 | 前置 | 步骤 | 期望 |
 | --- | --- | --- | --- | --- |
 | TC-REG-001 | 注册成功 | 无 | 输入合法用户名/口令→提交 | 201，用户入库 |
 | TC-AUTH-002 | 登录失败 | 无 | 错误口令→提交 | 401，AUTH_FAILED |
 | TC-ITEM-003 | 发布非法金额 | 已登录 | price<=0→提交 | 422，VALIDATION_ERROR |
 | TC-SEARCH-004 | 搜索无结果 | 无 | keywords=稀有词 | 200，total=0 |
 | TC-DETAIL-005 | 查看详情聚合 | 无 | GET /items/{id} | 200，含 offers/comments |
 | TC-OFFER-006 | 自报价拦截 | 卖家登录 | 对自家商品报价 | 403，SELF_OFFER_NOT_ALLOWED |
 | TC-COMM-007 | 留言成功 | 已登录 | 提交留言 | 201，返回 commentId |
 | TC-MGMT-008 | 下架商品 | 资源所有者 | PATCH action=off | 200，状态=off |
 
 ### 6.2 非功能测试纲要
 - 性能：50/100 并发压测，关键接口 P95 指标；慢查询分析与索引验证。
 - 安全：鉴权/越权/注入/暴力破解；Cookie 安全属性校验；输入清洗。
 - 可靠：备份/恢复演练；幂等与重试场景；异常注入（数据库短暂不可用）。
 
 ### 6.3 Definition of Ready/Done
 - DoR：需求澄清、接口/DDL 定稿、验收标准明确、测试数据准备。
 - DoD：代码合并、单/集成测试通过、日志/监控到位、文档更新、演示通过。
 
 ---
 
 ## 7 实施计划与里程碑
 - Backlog 与排期：见 plan-backlog.md（B1-B10）。
 - 里程碑：M1 数据库可用 → M2 认证可用 → M3 商品主流程 → M4 互动闭环 → M5 验收。
 - 风险/假设：认证复杂度、搜索效果、审核策略、估算偏差；对应缓解见 plan-backlog.md。
 
 ---
 
 ## 8 附录（术语与资源）
 - 术语表：DFD、ER、P95、RPO/RTO、DoR/DoD（详见草稿与本文件各节）。
 - 资源索引：
   - DFD 图：../images/dfd-0.png, ../images/dfd-1.png, ../images/dfd-2a.png, ../images/dfd-2b.png, ../images/dfd-2c.png
  - OOA 图：../实验四 面向对象的软件分析.md/assets/ooa-*.png（源 .mmd 同目录）
  - 新图（Mermaid 源）：assets/derived/arch-logic.mmd, er.mmd, seq-search-detail.mmd, seq-comment.mmd（PNG 将在导出时生成）
  - 规范与脚本：api-spec.md, ../database/db-schema.sql, plan-backlog.md
 
 ---
 
 ## 9 交付检查清单（阶段性）
 - 映射表/一致性：已覆盖核心功能，缺口与决策（G1-G10）可执行修复方案已给出。
 - API/DB：覆盖“报价/留言/上下架”等关键路径；DDL 可直接初始化数据库。
 - NFR：已量化并给出验证方法；测试用例支撑验收。
 - Backlog：按价值与依赖排序；风险/假设清晰。
 - 待生成：assets/derived/*.png（需运行 mmdc 导出）。
